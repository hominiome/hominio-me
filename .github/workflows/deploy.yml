name: Deploy to Fly.io

on:
  push:
    branches:
      - main

jobs:
  deploy-sync:
    name: Deploy sync service
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Set Zero secrets
        run: |
          # Set secrets for sync service (directly from GitHub secrets)
          # ZERO_AUTH_SECRET is reused as admin password (same secret, different purpose)
          flyctl secrets set \
            ZERO_UPSTREAM_DB="${{ secrets.SECRET_ZERO_DEV_PG }}" \
            ZERO_AUTH_SECRET="${{ secrets.SECRET_ZERO_AUTH_SECRET }}" \
            ZERO_ADMIN_PASSWORD="${{ secrets.SECRET_ZERO_AUTH_SECRET }}" \
            --app hominio-me-sync
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deploy sync service (Zero cache server)
        run: |
          flyctl deploy --config fly.sync.toml --remote-only --app hominio-me-sync
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Ensure exactly 1 machine (no auto-scaling)
        run: |
          # Explicitly set scale count to 1 to prevent auto-scaling
          # This ensures only one machine runs, preventing replication slot conflicts
          flyctl scale count 1 --app hominio-me-sync
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: |
          bun install

      - name: Run database migration
        run: |
          # Run migration script to add new columns and update publication
          # This ensures the database schema matches the Zero schema definition
          bun run scripts/zero-migrate.js
        env:
          SECRET_ZERO_DEV_PG: ${{ secrets.SECRET_ZERO_DEV_PG }}

      - name: Deploy Zero schema permissions
        run: |
          # Deploy schema permissions to ensure Zero server has latest schema
          # This updates the replicated columns and permissions in the database
          bunx zero-deploy-permissions -p ./src/zero-schema.ts
        env:
          ZERO_UPSTREAM_DB: ${{ secrets.SECRET_ZERO_DEV_PG }}
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  deploy-main:
    name: Deploy main app
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy main app
        run: |
          flyctl deploy --remote-only \
            --build-arg SECRET_NEON_PG_AUTH="${{ secrets.SECRET_NEON_PG_AUTH }}" \
            --build-arg SECRET_GOOGLE_CLIENT_ID="${{ secrets.SECRET_GOOGLE_CLIENT_ID }}" \
            --build-arg SECRET_GOOGLE_CLIENT_SECRET="${{ secrets.SECRET_GOOGLE_CLIENT_SECRET }}" \
            --build-arg SECRET_AUTH_SECRET="${{ secrets.SECRET_AUTH_SECRET }}"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
