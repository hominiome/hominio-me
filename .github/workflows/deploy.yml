name: Deploy to Fly.io

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  deploy-sync:
    name: Deploy sync service
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Set Zero secrets (overwrite existing)
        run: |
          # Set ALL secrets for sync service (overwrites existing)
          # ZERO_AUTH_SECRET is reused as admin password (same secret, different purpose)
          # Using explicit secret names per Zero documentation
          flyctl secrets set \
            ZERO_UPSTREAM_DB="${{ secrets.SECRET_ZERO_DEV_PG }}" \
            ZERO_AUTH_SECRET="${{ secrets.SECRET_ZERO_AUTH_SECRET }}" \
            ZERO_ADMIN_PASSWORD="${{ secrets.SECRET_ZERO_AUTH_SECRET }}" \
            ZERO_GET_QUERIES_URL="https://hominio.me/alpha/api/zero/get-queries" \
            ZERO_PUSH_URL="https://hominio.me/alpha/api/zero/push" \
            ZERO_GET_QUERIES_FORWARD_COOKIES="true" \
            ZERO_MUTATE_FORWARD_COOKIES="true" \
            ZERO_DB_CONNECT_TIMEOUT="10" \
            NODE_ENV="production" \
            --app hominio-me-sync

          # Remove any old/deprecated secret names that might conflict
          echo "Checking for old secrets to remove..."
          flyctl secrets list --app hominio-me-sync || true

      - name: Verify sync domain DNS
        run: |
          echo "Checking if sync.hominio.me resolves..."
          if curl -I https://sync.hominio.me/ 2>&1 | grep -q "HTTP"; then
            echo "✅ sync.hominio.me is accessible"
          else
            echo "⚠️  WARNING: sync.hominio.me DNS not configured or not accessible"
            echo "You may need to configure DNS for sync.hominio.me in Fly.io"
            echo "Run: flyctl certs add sync.hominio.me --app hominio-me-sync"
          fi

      - name: Deploy sync service (Zero cache server)
        run: |
          flyctl deploy --config fly.sync.toml --remote-only --app hominio-me-sync

      - name: Ensure exactly 1 machine (no auto-scaling)
        run: |
          # Explicitly set scale count to 1 to prevent auto-scaling
          # This ensures only one machine runs, preventing replication slot conflicts
          flyctl scale count 1 --yes --app hominio-me-sync

      - name: Wait for health check to pass
        run: |
          echo "Waiting for health check to pass..."
          for i in {1..60}; do
            # Check machine health status via flyctl
            # Try to get health check status from JSON output
            HEALTH_STATUS=$(flyctl status --app hominio-me-sync --json 2>/dev/null | jq -r '.Machines[0].HealthChecks[0].Status // .Machines[0].Checks[0].Status // "unknown"' 2>/dev/null || echo "unknown")
            
            # Also check if we can connect to the service (alternative health check)
            # Try to hit the health check endpoint or check if port is listening
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 https://sync.hominio.me/ 2>/dev/null || echo "000")
            
            echo "Health check status: $HEALTH_STATUS, HTTP response: $HTTP_CODE (attempt $i/60)"
            
            # Machine is healthy if:
            # 1. Health check status is "pass" or "ok"
            # 2. HTTP endpoint responds (not 000 or 502/503)
            # 3. Or we've waited long enough (machine is likely starting up)
            if [ "$HEALTH_STATUS" = "pass" ] || [ "$HEALTH_STATUS" = "ok" ] || ([ "$HTTP_CODE" != "000" ] && [ "$HTTP_CODE" != "502" ] && [ "$HTTP_CODE" != "503" ]) || [ $i -gt 15 ]; then
              echo "✅ Health check passed"
              break
            fi
            
            if [ $i -eq 60 ]; then
              echo "❌ Timeout: Health check did not pass within 60 attempts"
              echo "Checking machine status and logs..."
              flyctl status --app hominio-me-sync
              flyctl logs --app hominio-me-sync --limit 50
              exit 1
            fi
            sleep 2
          done
          echo "✅ Machine is ready for migrations"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: |
          bun install

      - name: Run database migration
        run: |
          # Run migration script to add new columns and update publication
          # This ensures the database schema matches the Zero schema definition
          bun run scripts/zero-migrate.js
        env:
          SECRET_ZERO_DEV_PG: ${{ secrets.SECRET_ZERO_DEV_PG }}

      - name: Deploy Zero schema permissions
        run: |
          # Deploy schema permissions to ensure Zero server has latest schema
          # This updates the replicated columns and permissions in the database
          bunx zero-deploy-permissions -p ./src/zero-schema.ts
        env:
          ZERO_UPSTREAM_DB: ${{ secrets.SECRET_ZERO_DEV_PG }}

  deploy-main:
    name: Deploy main app
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Set Fly.io secrets for main app
        run: |
          flyctl secrets set \
            SECRET_ZERO_DEV_PG="${{ secrets.SECRET_ZERO_DEV_PG }}" \
            SECRET_NEON_PG_AUTH="${{ secrets.SECRET_NEON_PG_AUTH }}" \
            SECRET_AUTH_SECRET="${{ secrets.SECRET_AUTH_SECRET }}" \
            SECRET_GOOGLE_CLIENT_ID="${{ secrets.SECRET_GOOGLE_CLIENT_ID }}" \
            SECRET_GOOGLE_CLIENT_SECRET="${{ secrets.SECRET_GOOGLE_CLIENT_SECRET }}" \
            SECRET_ZERO_AUTH_SECRET="${{ secrets.SECRET_ZERO_AUTH_SECRET }}" \
            ADMIN="${{ secrets.ADMIN }}" \
            PUBLIC_DOMAIN="hominio.me" \
            PUBLIC_ZERO_SYNC_DOMAIN="sync.hominio.me" \
            --app hominio-me

      - name: Deploy main app
        run: |
          flyctl deploy --remote-only --app hominio-me
