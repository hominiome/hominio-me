name: Deploy to Fly.io

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  deploy-main-app:
    name: Deploy SvelteKit App (hominio.me)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Set Fly.io secrets for main app
        run: |
          flyctl secrets set \
            SECRET_ZERO_DEV_PG="${{ secrets.SECRET_ZERO_DEV_PG }}" \
            SECRET_NEON_PG_AUTH="${{ secrets.SECRET_NEON_PG_AUTH }}" \
            SECRET_AUTH_SECRET="${{ secrets.SECRET_AUTH_SECRET }}" \
            SECRET_GOOGLE_CLIENT_ID="${{ secrets.SECRET_GOOGLE_CLIENT_ID }}" \
            SECRET_GOOGLE_CLIENT_SECRET="${{ secrets.SECRET_GOOGLE_CLIENT_SECRET }}" \
            SECRET_ZERO_AUTH_SECRET="${{ secrets.SECRET_ZERO_AUTH_SECRET }}" \
            ADMIN="${{ secrets.ADMIN }}" \
            PUBLIC_ZERO_SERVER="wss://sync.hominio.me" \
            SECRET_ZERO_GET_QUERIES_URL="https://hominio.me/alpha/api/zero/get-queries" \
            SECRET_ZERO_PUSH_URL="https://hominio.me/alpha/api/zero/push" \
            PUBLIC_BASE_URL="https://hominio.me" \
            --app hominio-me

      - name: Deploy main app to Fly.io
        run: flyctl deploy --remote-only --app hominio-me

  deploy-sync-service:
    name: Deploy Zero Sync Service (sync.hominio.me)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Set Fly.io secrets for sync service
        run: |
          flyctl secrets set \
            ZERO_UPSTREAM_DB="${{ secrets.SECRET_ZERO_DEV_PG }}" \
            ZERO_AUTH_SECRET="${{ secrets.SECRET_ZERO_AUTH_SECRET }}" \
            ZERO_GET_QUERIES_URL="https://hominio.me/alpha/api/zero/get-queries" \
            ZERO_PUSH_URL="https://hominio.me/alpha/api/zero/push" \
            ZERO_GET_QUERIES_FORWARD_COOKIES="true" \
            ZERO_MUTATE_FORWARD_COOKIES="true" \
            ZERO_DB_CONNECT_TIMEOUT="10" \
            NODE_ENV="production" \
            --app hominio-me-sync

      - name: Deploy sync service to Fly.io
        run: flyctl deploy --remote-only --app hominio-me-sync
