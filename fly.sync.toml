# fly.toml for sync service (Zero cache server)
# This is a separate Fly.io app that runs the Zero cache server

app = 'hominio-me-sync'
primary_region = 'fra'

[build]
# Use custom Dockerfile with Bun support
dockerfile = "Dockerfile.sync"

[http_service]
internal_port = 4848
force_https = true
# Prevent auto-shutdown - Zero cache needs to stay running to maintain replication
auto_stop_machines = "off"
# Keep at least one machine running - multiple instances cause replication slot conflicts
# IMPORTANT: Run 'fly scale count 1 -a hominio-me-sync' to ensure only one machine runs
min_machines_running = 1

[[http_service.checks]]
# Increased grace period to allow Zero to fully initialize and avoid premature health check failures
grace_period = "60s"
interval = "30s"
method = "GET"
timeout = "10s"
path = "/"

[[vm]]
memory = "2gb"
cpu_kind = "shared"
cpus = 2

[mounts]
source = "sync_sqlite_db"
destination = "/data"

[env]
ZERO_REPLICA_FILE = "/data/sync-replica.db"
ZERO_PORT = "4848"
# ZERO_UPSTREAM_DB will be set via Fly.io secrets
# IMPORTANT: Must use DIRECT connection (not pooler) for replication slots!
# Pooler connections don't support logical replication and will cause:
# "terminating connection due to administrator command" errors
# Use: bun scripts/convert-to-direct-connection.js <your-pooler-url>
# ZERO_AUTH_SECRET will be set via Fly.io secrets
# ZERO_ADMIN_PASSWORD will be set via Fly.io secrets
LOG_LEVEL = "info"
# Increase connection timeout to handle high-latency database connections
ZERO_DB_CONNECT_TIMEOUT = "15"
# Prevent Postgres from terminating idle replication connections
# This helps avoid "terminating connection due to administrator command" errors
PGCONNECT_TIMEOUT = "15"
